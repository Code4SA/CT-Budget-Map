<!DOCTYPE html>
<html>
  <head>
	<title>City of Cape Town Capital Budget 2014/15</title>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
	<!-- <link rel="shortcut icon" href="http://cartodb.com/assets/favicon.ico" /> -->
	<link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="style.css">
    <link href='http://fonts.googleapis.com/css?family=Amatic+SC:400,700' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
	<link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.css" />
    <script src="js/modernizr.custom.js"></script>
	<!--[if lte IE 8]>
		<link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.ie.css" />
	<![endif]-->
  </head>
  <body>
	<div id="map"></div>
	<div class="container">
    	<div class="input-group">
			<input type="text" id="search" class="form-control" value="" placeholder="Street, Suburb">
			<span class="input-group-btn">
				<button id="searchbtn" class="btn">Search</button>
			</span>
		</div>
	</div>
 	<div id="content" class="container">
 		<h3>How is the capital budget being spent in your area?</h3>
        <p>Use the menu at the top right to view different map layers. <br>Click on a ward on the map for more detailed information. <br>Show and hide more detailed information about the project using the button near the top left.</p>
 	</div>
	<!-- include cartodb.js library -->
	<script src="http://libs.cartocdn.com/cartodb.js/v3/cartodb.js"></script>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
	<script src="bower_components/handlebars/handlebars.min.js"></script>
	<script>
	var sql = new cartodb.SQL({ user: 'ndifunaukwazi' });
	var url = 'http://ndifunaukwazi.cartodb.com/api/v2/viz/1c061a5e-cd98-11e4-bd11-0e9d821ea90d/viz.json';
	$(function() {
		cartodb.createVis('map', url, {
			scrollwheel: false,
			search: false,
			legend: true,
			
		})
		.done(function(vis, layers) {
			  // Set max zoom
         	vis.map.set({
            minZoom: 9,
            maxZoom: 15,
          });
			for(var x = 0; x < 4; x++) {
				layers[1].getSubLayer(x).on("featureClick", function(e, latlng, pos, data, subLayerIndex) {
					$("#content").html("<img src='http://libs.cartocdn.com/cartodb.js/v3/themes/img/loader.gif'>");
					sql.execute("SELECT table_budget_2014_15_merge.*, table_budget_2014_15_merge.budget_2014_15 AS total_budget, march2015_projectsformap.* FROM table_budget_2014_15_merge, march2015_projectsformap WHERE table_budget_2014_15_merge.cartodb_id = {{id}} AND table_budget_2014_15_merge.wardno = march2015_projectsformap.ward AND march2015_projectsformap.budget_2014_15 > 0", { id: data.cartodb_id })
					.done(function(data) {
						var template = Handlebars.compile($("#ward_template").html());
						$("#content").html(template({ ward: data.rows[0], projects: data.rows }));
					})
					.error(function(errors) {
						console.log("errors:" + errors);
					})
				});
			}
		});

		var wardsapi = "http://wards.code4sa.org/wards/2011/";
		// var wardsapi = "http://127.0.0.1:5000/";

		$("#searchbtn").on("click", function() {
			search();
		});
		$("#search").on("keypress", function(e) {
			if (e.keyCode == 13) {
				search();
			}
		})
		var search = function() {
			s = $("#search").val();
			if (s.indexOf("Cape Town") == -1) {
				s = s + " Cape Town";
			}
			$("#content").html("<img src='http://libs.cartocdn.com/cartodb.js/v3/themes/img/loader.gif'>");
			$.get(wardsapi, { address: s })
			.done(function(data) {
				if (data.error) {
					$("#content").html("<h4>" + data.error + "</h4>");
					return;
				}
				console.log(data);
				ward = data.pop();
				sql.execute("SELECT table_budget_2014_15_merge.*, table_budget_2014_15_merge.budget_2014_15 AS total_budget, march2015_projectsformap.* FROM table_budget_2014_15_merge, march2015_projectsformap WHERE table_budget_2014_15_merge.wardno = {{ward_id}} AND table_budget_2014_15_merge.wardno = march2015_projectsformap.ward AND march2015_projectsformap.budget_2014_15 > 0", { ward_id: ward.wards_no })
					.done(function(data) {
						var template = Handlebars.compile($("#ward_template").html());
						$("#content").html(template({ ward: data.rows[0], projects: data.rows }));
					})
					.error(function(errors) {
						console.log("errors:" + errors);
					})
			})
			.fail(function() {
				$("#content").html("<h4>We've had a problem searching. Please try again later.</h4>");
			});
		}
	});

	Handlebars.registerHelper('formatCurrency', function(value) {
		return "ZAR&nbsp;" + Math.round(value).toLocaleString();
	});

	Handlebars.registerHelper('formatNumber', function(value) {
		return value.toLocaleString();
	});
 
	</script>
	<script type="text/x-handlebars-template" id="ward_template">
	<div class="leftColumn">
		<h1>Ward <span id="ward-id">{{ ward.wardno }}</span></h1>
		<dl>
			<dt>Population</dt> <dd>{{ formatNumber ward.population }}</dd>
			<dt>Number of projects</dt> <dd>{{ formatNumber ward.no_projects_2014_15 }}</dd>
			<dt>Registered Voters</dt> <dd>{{ formatNumber ward.reg_voters }}</dd>
			<dt>Party</dt> <dd>{{ ward.wardwinner }}</dd>
			<dt>Total Capital Project Budget</dt> <dd>{{{ formatCurrency ward.total_budget }}}</dd>
		</dl>
		
	</div>
	<div class="rightColumn">
		<div id="capital_expenditure">
		<h3>Expenditures</h3>
			<table class="table table-striped table-bordered">
			<tr>
				<th>Project ID</th>
				<th>Department</th>
				<th>Project Description</th>
				<th>Budget</th>
			</tr>
			{{#each projects}}
			<tr>
				<td>{{ project_id }}</td>
				<td>{{ department }}</td>
				<td>{{ description }}</td>
				<td>{{{ formatCurrency budget_2014_15 }}}</td>
			</tr>
			{{/each}}
			<tr>
				<td></td>
				<td></td>
				<td></td>
				<th>{{{ formatCurrency ward.total_budget }}}</th>
			</table>
		</div>
		</div>
	</script>
    
    <!-- Classie - class helper functions by @desandro https://github.com/desandro/classie -->
		<script src="js/classie.js"></script>
        
        <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-48399585-16', 'auto');
  ga('send', 'pageview');

</script>


  </body>
</html>