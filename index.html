<!DOCTYPE html>
<html>
  <head>
	<title>Layer selector example | CartoDB.js</title>
	<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
	<meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
	<link rel="shortcut icon" href="http://cartodb.com/assets/favicon.ico" />
	<link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css">
	<style>
	  html, body {
		height: 100%;
		padding: 0;
		margin: 0;
	  }

	  #map {
	  	height: 80px;
	  	height: 80vh;
	  }
 
	  #layer_selector {
		position: absolute;
		top: 60px;
		right: 20px;
		padding: 0;
	  }
 
	  #layer_selector ul {
		padding: 0; margin: 0;
		list-style-type: none;
	  }
 
	  #layer_selector li {
		border-bottom: 1px solid #999;
		padding: 15px 30px;
		font-family: "Helvetica", Arial;
		font-size: 13px;
		color: #444;
		cursor: auto;
	  }
 
	  #layer_selector li:hover {
		background-color: #F0F0F0;
		cursor: pointer;
	  }
 
	  #layer_selector li.selected {
		background-color: #eee;
	  }
	</style>
 
	<link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.css" />
	<!--[if lte IE 8]>
		<link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.ie.css" />
	<![endif]-->
  </head>
  <body>
	<div id="map"></div>
	<div id="layer_selector" class="cartodb-infobox">
	  <ul>
		<li id="abc" data-layer="1">Capital Project Spend Per Capita</li>
		<li id="efg" data-layer="2">Total Capital Project Budget</li>
		<li id="hij" data-layer="3">Number of Capital Projects</li>
	  </ul>
	</div>
 	<div id="content" class="container">
 		Stuff to come here
 	</div>
	<!-- include cartodb.js library -->
	<script src="http://libs.cartocdn.com/cartodb.js/v3/cartodb.js"></script>
	<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
	<script src="bower_components/handlebars/handlebars.min.js"></script>
	<script>
	var sql = new cartodb.SQL({ user: 'msnimbus' });
	var url = 'http://msnimbus.cartodb.com/api/v2/viz/eb10de06-7a19-11e4-bbe9-0e9d821ea90d/viz.json';
	$(function() {
		cartodb.createVis('map', url, {
			scrollwheel: false,
		})
		.done(function(vis, layers) {
			vis.getOverlay("layer_selector").hide();
			layers[1].getSubLayer(1).show();
			$('#layer_selector li').on("click", function(e) {
				var layer = $(this).attr('data-layer');
				$("#layer_selector li").removeClass("selected");
				$(this).addClass("selected");
				for(var x = 1; x < 4; x++) {
					layers[1].getSubLayer(x).hide();
				}
				layers[1].getSubLayer(layer).show();
			});
			for(var x = 1; x < 4; x++) {
				layers[1].getSubLayer(x).on("featureClick", function(e, latlng, pos, data, subLayerIndex) {
					console.log(data);
					
					sql.execute("SELECT * FROM capetown_budget_map WHERE cartodb_id = {{id}}", { id: data.cartodb_id })
					.done(function(data) {
						
						data = data.rows[0];
						console.log(data);
						
						$.get("https://data.code4sa.org/resource/capital-projects-wards-cape-town.json?ward=" + data.ward_number, function(expenditures) {
							data.expenditures = expenditures;
							console.log(expenditures);
							var template = Handlebars.compile($("#ward_template").html());
							$("#content").html(template(data));
							
						})
					})
					.error(function(errors) {
						// errors contains a list of errors
						console.log("errors:" + errors);
					})
				});
			}
		});
	});

	Handlebars.registerHelper('formatCurrency', function(value) {
		return "ZAR" + value.toLocaleString();
	});

	Handlebars.registerHelper('formatNumber', function(value) {
		return value.toLocaleString();
	});
 
	  var layerN = {};
	</script>
	<script type="text/x-handlebars-template" id="ward_template">
		<h1>Ward <span id="ward-id">{{ data.ward_number }}</span></h1>
		<dl>
			<dt>Population</dt> <dd>{{ formatNumber population }}</dd>
			<dt>Number of projects</dt> <dd>{{ formatNumber number_of_capital_projects_in_this_ward }}</dd>
			<dt>Registered Voters</dt> <dd>{{ formatNumber reg_voters }}</dd>
			<dt>Party</dt> <dd>{{ wardwinner }}</dd>
			<dt>Total Capital Project Budget</dt> <dd>{{ formatCurrency total_capital_project_budget_for_this_ward }}</dd>
		</dl>
		<div id="capital_expenditure">
		<h3>Expenditures</h3>
			<table class="table table-striped table-bordered">
			<tr>
				<th>Project ID</th>
				<th>Project Description</th>
			</tr>
			{{#each expenditures}}
			<tr>
				<td>{{ project_id }}</td>
				<td>{{ project_description }}</td>
			</tr>
			{{/each}}
			</table>
		</div>
	</script>


  </body>
</html>